# Firebase Notification server

This directory provides services and accompanying files required to run the FCM notifications server. Currently, [XMPP App server](https://github.com/RADAR-base/fcmxmppserverv2) is provided but this may later change to the [RADAR-AppServer](https://github.com/RADAR-base/RADAR-Appserver).

## Configuration

Copy `etc/env.template` to `.env`. Set the values of the new file to the desired values.

```sh
FCM_XMPP_APP_SERVER_DB_PATH= # The path on the host where to store database files
FCM_XMPP_APP_SERVER_LOGS_PATH= # The path on the host where to store the log files generated by the server
FCM_SENDER_KEY= # The Firebase Cloud Messaging Sender ID
FCM_SERVER_KEY= # # The Firebase Cloud Messaging Server Key
```

For more information, take a look at the instruction in the [README](https://github.com/RADAR-base/fcmxmppserverv2).

If the server is not running in a secure environment, it may be essential to explicitly add username and password to the database.
This can be done by changing the `server.database.n` properties in the [server.properties](/etc/server.properties) file and appending with your username and password as stated [here](http://hsqldb.org/doc/guide/guide.html#N15798). Then add the same to the environment of the `xmppserver` in [docker-compose.yml](/docker-compose.yml) file with keys `RADAR_XMPP_DB_USER` and `RADAR_XMPP_DB_PASS`.

## Usage

Since the App Server does not depend on any other services, it can be run separately by running -

```sh
bin/start-xmpp -d
```

It can be further controlled with `docker-compose` and `docker` commands.

## Extras

There are some extra scripts provided for convenience when administering the server in `bin/` folder.

- `get-subject-data.sh` -  this can be used for getting the notifications, and other data for a particular subject using their subject Id. Note that this will require the [sqltool.jar](http://hsqldb.org/doc/2.0/util-guide/sqltool-chapt.html) from hsqldb. You will also need to update any settings in (sqltool.rc)[/etc/sqltool.rc] according to your DB setup. Once configured, The script can be used as follows -
    ```sh
    ./get-subject-data.sh <subject_id> <path_to_sqltool.jar_file>
    ```

- `log-parser.py` - This is used for parsing information out of the logs files generated by the server. This is supposed to be run as a cron job for creating CSV files for Execution, delivery and error messages for each notification request over a long period of time. This can be run in cron per day as follows -
    ```sh
    0 16 * * * python3 /home/ubuntu/xmpp-server-extras/logs-parser/log-parser.py /usr/local/var/lib/radar/xmpp/hsql/logs/ /home/ubuntu/xmpp-server-extras/logs-parser/files >> /home/ubuntu/log-parser-run.log 2>&1
    ```
    This will output the CSV files in the directory `/home/ubuntu/xmpp-server-extras/logs-parser/files` which contain three files for each day (One for Executions, One for Delivery and One for Errors).

- `install-systemd` Run the xmpp server in a systemd environment as part of system startup.

## Other information

If you are in a development environment, It may be worth trying to use the new and improved [RADAR-AppServer](https://github.com/RADAR-base/RADAR-Appserver/tree/dev). It exposes REST endpoints along with supporting the legacy XMPP and has secure integration with the Management Portal.
